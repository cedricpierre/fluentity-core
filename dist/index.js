class I{constructor(J){if(J)Object.assign(this,J)}url;model;id;parent;query={};sort;direction;limit;offset;page;perPage;method;body;where(J){return this.filter(J),this}filter(J){return this.query={...this.query,...J},this}reset(){this.id=void 0,this.query={},this.sort=void 0,this.direction=void 0,this.limit=void 0,this.offset=void 0,this.page=void 0,this.perPage=void 0,this.method=void 0,this.body=void 0,this.model=void 0}toObject(){return Object.entries({query:this.query,method:this.method,sort:this.sort,direction:this.direction,limit:this.limit,offset:this.offset,page:this.page,perPage:this.perPage}).filter(([J,V])=>V!==void 0).reduce((J,[V,W])=>{return J[V]=W,J},{})}}class N{static scopes;id;#J;static resource;constructor(J,V){if(J)Object.assign(this,J);return this.#J=V??new I({model:this.constructor,id:this.id}),this}get queryBuilder(){return this.#J}get fluentity(){return L.getInstance()}static getRelationBuilder(J,V){let W=new J({});return new V(W)}static id(J){return new this({id:J})}static query(){return N.getRelationBuilder(this,_)}static where(J){return N.getRelationBuilder(this,_).where(J)}static filter(J){return N.getRelationBuilder(this,_).filter(J)}static async all(){return await N.getRelationBuilder(this,_).all()}static async find(J){return await N.getRelationBuilder(this,S).find(J)}static async create(J){return await N.getRelationBuilder(this,_).create(J)}static async update(J,V,W=$.PUT){return await N.getRelationBuilder(this,_).update(J,V,W)}static async delete(J){return N.getRelationBuilder(this,_).delete(J)}async get(){this.#J.method=$.GET;let J=await this.fluentity.adapter.call(this.#J);return Object.assign(this,J.data),this}async save(){if(this.id)return this.update();this.#J.method=$.POST,this.#J.body=this.toObject();let J=await this.fluentity.adapter.call(this.#J);return Object.assign(this,J.data),this}async update(J,V=$.PUT){if(J)Object.assign(this,J);this.#J.method=V,this.#J.id=this.id,this.#J.body=this.toObject();let W=await this.fluentity.adapter.call(this.#J);return Object.assign(this,W.data),this}async delete(){this.#J.method=$.DELETE,await this.fluentity.adapter.call(this.#J)}async call(J){return this.constructor.call(J)}static async call(J){return await L.getInstance().adapter.call(J)}toObject(){let J={};Object.keys(this).forEach((W)=>{J[W]=this[W]});let V=Object.getOwnPropertyDescriptors(Object.getPrototypeOf(this));for(let[W,X]of Object.entries(V))if(X.get){let Z=this[W];if(Z instanceof N)J[W]=Z.toObject();else if(Array.isArray(Z)&&Z.length>0)J[W]=Z.filter((Y)=>Y instanceof N&&typeof Y.toObject==="function").map((Y)=>Y.toObject())}return J}reset(...J){for(let V of J)this[V]=void 0;return this}}class U{#J;#V;#W;constructor(J,V){if(this.#V=J,this.#J=new I({model:this.#V}),V)this.#J.parent={...V};if(this.#V.scopes)Object.entries(this.#V.scopes).forEach(([W,X])=>{this[W]=(...Z)=>{return X(this,...Z)}})}get data(){return this.#W}set data(J){this.#W=J}get fluentity(){return L.getInstance()}get queryBuilder(){return this.#J}get relatedModel(){return this.#V}id(J){return this.#J.id=J,new this.#V({id:J},this.#J)}async find(J){this.#J.id=J,this.#J.method=$.GET;let V=await this.fluentity.adapter.call(this.#J),W=new this.#V(V.data,this.#J);return W.queryBuilder.id=J,W}where(J){return this.#J.where(J),this}filter(J){return this.#J.filter(J),this}orderBy(J="id",V="asc"){return this.#J.sort=J,this.#J.direction=V,this}limit(J){return this.#J.limit=J,this}offset(J){return this.#J.offset=J,this}}class _ extends U{async all(){this.queryBuilder.method=$.GET,this.queryBuilder.id=void 0;let J=await this.fluentity.adapter.call(this.queryBuilder);return this.data=J?.data?.map((V)=>new this.relatedModel(V,{...this.queryBuilder,id:V.id}))}async create(J){this.queryBuilder.method=$.POST,this.queryBuilder.body=J,this.queryBuilder.id=void 0;let V=await this.fluentity.adapter.call(this.queryBuilder);return this.data=new this.relatedModel(V.data,{...this.queryBuilder,id:V.data.id})}async delete(J){this.queryBuilder.method=$.DELETE,this.queryBuilder.id=J,await this.fluentity.adapter.call(this.queryBuilder)}async update(J,V,W=$.PUT){this.queryBuilder.method=W,this.queryBuilder.id=J,this.queryBuilder.body=V;let X=await this.fluentity.adapter.call(this.queryBuilder);return this.data=new this.relatedModel(X.data,{...this.queryBuilder,id:X.data.id})}async paginate(J=1,V=10){this.queryBuilder.page=J,this.queryBuilder.perPage=V,this.queryBuilder.offset=(J-1)*V,this.queryBuilder.limit=V;let W=await this.fluentity.adapter.call(this.queryBuilder);return this.data=W?.data?.map((X)=>new this.relatedModel(X,{...this.queryBuilder,id:X.id}))}}class S extends U{async get(){this.queryBuilder.method=$.GET;let J=await this.fluentity.adapter.call(this.queryBuilder);return this.data=new this.relatedModel(J.data,{...this.queryBuilder,id:J.data.id})}async update(J,V=$.PUT){this.queryBuilder.method=V,this.queryBuilder.id=this.relatedModel.id;let W=await this.fluentity.adapter.call(this.queryBuilder);return this.data=new this.relatedModel(W.data,{...this.queryBuilder,id:W.data.id})}async delete(){this.queryBuilder.method=$.DELETE,this.queryBuilder.id=this.relatedModel.id,await this.fluentity.adapter.call(this.queryBuilder)}}var A=(J,V,W)=>{let X=new WeakMap;return function(Z,Y){let z=Symbol(String(Y));Object.defineProperty(Z,Y,{get(){let G=X.get(this)??new V(J(),this.queryBuilder);if(X.set(this,G),this[z]!==void 0){let P=this[z],j=J();if(Array.isArray(P))G.data=P.map((D)=>D instanceof j?D:new j(D));else G.data=new j(P)}return G},set(G){this[z]=G},enumerable:!0,configurable:!0})}},i=(J)=>{return function(V,W){let X=Symbol(String(W)),Z=J();Object.defineProperty(V,W,{get(){if(!this[X])this[X]=void 0;let Y=this[X];if(!Y||!Z)return Y;if(Array.isArray(Y))return Y.map((z)=>z instanceof Z?z:new Z(z));else if(Y instanceof Z)return Y;else return new Z(Y)},set(Y){if(!Z){this[X]=Y;return}if(Array.isArray(Y))this[X]=Y.map((z)=>z instanceof Z?z:new Z(z));else if(Y instanceof Z)this[X]=Y;else this[X]=new Z(Y)},enumerable:!0,configurable:!0})}},Q=(J,V)=>{return A(J,S,V)},T=(J,V)=>{return A(J,_,V)},t=Q,u=T;class K{options={};async call(J){return Promise.resolve({data:void 0})}configure(J){}}class L{static instance;#J;#V;constructor(J){if(L.instance)throw new Error("Fluentity instance already exists. Use getInstance() instead.");this.#V=J,this.#J=J?.adapter??new K,L.instance=this}configure(J){if(!L.instance)throw new Error("Fluentity has not been initialized. Call initialize() first.");this.#V=J,this.#J=J?.adapter??new K}get adapter(){return this.#J}static initialize(J){if(L.instance)throw new Error("Fluentity has already been initialized. Use getInstance() instead.");return new L(J)}static reset(){L.instance=void 0}static getInstance(){if(!L.instance)throw new Error("Fluentity has not been initialized. Call initialize() first.");return L.instance}call(J){return this.#J.call(J)}static call(J){return L.getInstance().call(J)}}var $={GET:"GET",POST:"POST",PUT:"PUT",PATCH:"PATCH",DELETE:"DELETE",HEAD:"HEAD",OPTIONS:"OPTIONS"};class O{_cache=new WeakMap;options={baseUrl:"",options:{headers:{"Content-Type":"application/json"}},requestInterceptor:void 0,responseInterceptor:void 0,errorInterceptor:void 0,requestHandler:this.fetchRequestHandler,cacheOptions:{enabled:!1,ttl:300000}};_request=new x;constructor(J){if(!J.baseUrl)throw new Error("baseUrl is required");this.options={...this.options,...J}}configure(J){return this.options={...this.options,...J},this}get request(){return this._request}clearCache(){return this._cache=new WeakMap,this}async call(J){try{if(!this.options.baseUrl)throw new Error("baseUrl is required");if(this._request=this.buildRequest(J),this.options.cacheOptions?.enabled){let W=this._cache.get(this._request);if(W){if(Date.now()-W.timestamp<(this.options.cacheOptions.ttl||0))return W;this._cache.delete(this._request)}}if(this.options.requestInterceptor)Object.assign(this._request,this.options.requestInterceptor.call(this,this._request));let V=await this.options.requestHandler.call(this,this._request);if(this.options.responseInterceptor)V=this.options.responseInterceptor.call(this,V);if(this.options.cacheOptions?.enabled)this._cache.set(this._request,{data:V,timestamp:Date.now()});return V}catch(V){if(this.options.errorInterceptor&&V instanceof Error)this.options.errorInterceptor(V);throw V}}buildRequest(J){return new x({url:"",method:J.method,body:J.body,options:this.options?.options})}async fetchRequestHandler(J){return Promise.resolve(new E)}}class x{url="";options;method;body;constructor(J){if(J)Object.assign(this,J)}}class E{data={};constructor(J){if(J)Object.assign(this,J)}}class C extends O{constructor(J){super(J);this.options={...this.options,...J}}buildRequest(J){return new x({url:this.buildUrl(J),method:J.method,body:J.body,options:this.options?.options})}buildUrl(J){let V=this.toQueryString(J),W=[];W=this.unwrapParents(J,W);let X=W.join("/");if(V)X+=`?${V}`;return decodeURIComponent(X)}unwrapParents(J,V){if(J.parent)this.unwrapParents(J.parent,V);if(V.push(J.url??J.model?.resource),J.id)V.push(`${J.id}`);return V}toQueryString(J){let V={...J.query};return V.page=J.page,V.perPage=J.perPage,V.sort=J.sort,V.direction=J.direction,V.limit=J.limit,V.offset=J.offset,Object.entries(V).filter(([W,X])=>X!==void 0).map(([W,X])=>`${W}=${X}`).join("&")}async fetchRequestHandler(J){if(J.options?.headers?.["Content-Type"]==="application/json"&&J.body)J.body=JSON.stringify(J.body);try{let V=await fetch(`${this.options.baseUrl}/${J.url}`,{method:J.method,body:["PUT","POST","PATCH"].includes(J.method)?J.body:null,headers:J.options?.headers,credentials:J.options?.credentials,mode:J.options?.mode,redirect:J.options?.redirect,referrer:J.options?.referrer,cache:J.options?.cache,keepalive:J.options?.keepalive,signal:J.options?.signal});return new E({data:await V.json()})}catch(V){throw new Error(`HTTP error: ${V}`)}}}class H extends O{constructor(J){super(J);if(!J.endpoint)throw new Error("GraphqlAdapter requires an endpoint");this.options={...this.options,...J}}buildRequest(J){return new x({url:this.options.endpoint??"/graphql",method:J.method??$.POST,body:this.buildBody(J),options:this.options?.options})}buildBody(J){return{query:this.buildGraphQLQuery(J),variables:this.buildVariables(J),operationName:this.generateOperationName(J)}}determineOperation(J){switch(J.method){case"GET":return"query";case"POST":case"PUT":case"PATCH":return"mutation";case"DELETE":return"mutation";default:return"query"}}buildGraphQLQuery(J){let V=this.determineOperation(J),W=J.model?.resource??"resource",X=this.buildFields(J),Z=this.buildArguments(J),Y=`${V} ${this.generateOperationName(J)}`;if(Z.length>0)Y+=`(${Z.join(", ")})`;return Y+=` {
  ${W}${this.buildQueryArguments(J)} {
    ${X}
  }
}`,Y}buildFields(J){let V=new Set;if(V.add("id"),J.query)Object.keys(J.query).forEach((W)=>{if(typeof J.query[W]==="boolean"&&J.query[W])V.add(W)});if(J.body&&typeof J.body==="object")Object.keys(J.body).forEach((W)=>{if(typeof J.body[W]==="boolean"&&J.body[W])V.add(W)});if(J.parent){let W=this.buildFields(J.parent);V.add(W)}return Array.from(V).join(`
    `)}buildArguments(J){let V=[];if(J.id)V.push("$id: ID!");if(J.limit)V.push("$limit: Int");if(J.offset)V.push("$offset: Int");if(J.page)V.push("$page: Int");if(J.perPage)V.push("$perPage: Int");if(J.sort)V.push("$sort: String");if(J.direction)V.push("$direction: String");if(J.query&&Object.keys(J.query).length>0)V.push("$filters: JSON");if(J.body&&this.determineOperation(J)==="mutation")V.push("$input: JSON!");return V}buildQueryArguments(J){let V=[];if(J.id)V.push("id: $id");if(J.limit)V.push("limit: $limit");if(J.offset)V.push("offset: $offset");if(J.page)V.push("page: $page");if(J.perPage)V.push("perPage: $perPage");if(J.sort)V.push("sort: $sort");if(J.direction)V.push("direction: $direction");if(J.query&&Object.keys(J.query).length>0)V.push("filters: $filters");if(J.body&&this.determineOperation(J)==="mutation")V.push("input: $input");return V.length>0?`(${V.join(", ")})`:""}buildVariables(J){let V={};if(J.id)V.id=J.id;if(J.limit)V.limit=J.limit;if(J.offset)V.offset=J.offset;if(J.page)V.page=J.page;if(J.perPage)V.perPage=J.perPage;if(J.sort)V.sort=J.sort;if(J.direction)V.direction=J.direction;if(J.query&&Object.keys(J.query).length>0)V.filters=J.query;if(J.body&&this.determineOperation(J)==="mutation")V.input=J.body;return V}generateOperationName(J){let V=J.model?.resource||"resource",W=J.method||"GET";if(J.id)return`Get${V.charAt(0).toUpperCase()+V.slice(1)}ById`;switch(W){case"GET":return`Get${V.charAt(0).toUpperCase()+V.slice(1)}`;case"POST":return`Create${V.charAt(0).toUpperCase()+V.slice(1)}`;case"PUT":case"PATCH":return`Update${V.charAt(0).toUpperCase()+V.slice(1)}`;case"DELETE":return`Delete${V.charAt(0).toUpperCase()+V.slice(1)}`;default:return`Get${V.charAt(0).toUpperCase()+V.slice(1)}`}}}export{C as RestAdapter,U as RelationBuilder,I as QueryBuilder,N as Model,$ as Methods,E as HttpResponse,x as HttpRequest,O as HttpAdapter,S as HasOneRelationBuilder,Q as HasOne,_ as HasManyRelationBuilder,T as HasMany,H as GraphqlAdapter,L as Fluentity,K as DefaultAdapter,i as Cast,u as BelongsToMany,t as BelongsTo};
